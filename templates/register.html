{% extends "base.html" %} {% block title %}OTB - Register{% endblock %} {% block
meta_description %}Create your OTB account to join tournaments and events.{%
endblock %} {% block content %}

<div class="container container-tight py-4">
  <form id="register-form" class="card card-md" autocomplete="off" novalidate>
    <div class="card-body">
      <h2 class="card-title text-center mb-4 fs-1">Create your account</h2>

      <!-- USERNAME -->
      <div class="mb-3">
        <label class="form-label required">Username</label>
        <input
          type="text"
          id="username"
          class="form-control"
          placeholder="Enter username"
          required
        />
        <div class="invalid-feedback">Username is required.</div>
      </div>

      <!-- EMAIL -->
      <div class="mb-3">
        <label class="form-label required">Email address</label>
        <input
          type="email"
          id="email"
          class="form-control"
          placeholder="Enter email"
          required
        />
        <div class="invalid-feedback">Please enter a valid email.</div>
      </div>

      <!-- PASSWORD -->
      <div class="mb-3">
        <label class="form-label required">Password</label>
        <div class="input-group input-group-flat">
          <input
            type="password"
            id="password"
            class="form-control"
            placeholder="Password"
            required
          />
          <span class="input-group-text">
            <a
              href="#"
              class="link-secondary"
              id="togglePassword"
              aria-label="Show password"
            >
              <!-- INITIALLY EYE CLOSED -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                id="eyeIcon"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="icon icon-tabler icon-tabler-eye-closed"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path
                  d="M21 9c-2.4 2.667 -5.4 4 -9 4c-3.6 0 -6.6 -1.333 -9 -4"
                />
                <path d="M3 15l2.5 -3.8" />
                <path d="M21 14.976l-2.492 -3.776" />
                <path d="M9 17l.5 -4" />
                <path d="M15 17l-.5 -4" />
              </svg>
            </a>
          </span>
        </div>
        <div class="invalid-feedback">Password is required.</div>
      </div>

      <!-- SUBMIT -->
      <div class="form-footer">
        <button type="submit" class="btn btn-primary w-100">
          Create account
        </button>
      </div>
    </div>
  </form>

  <!-- LOGIN -->
  <div class="text-center text-secondary mt-3">
    Already have an account? <a href="/login" tabindex="-1">Login</a>
  </div>
</div>

<!-- ALERT MESSAGE -->
<div
  class="toast-container position-fixed top-0 end-0 p-3"
  id="toast-container"
></div>

<script>
  const form = document.getElementById("register-form");
  const inputs = form.querySelectorAll("input");
  const toastContainer = document.getElementById("toast-container");

  // ---- SHOW/HIDE PASSWORD ----
  document
    .getElementById("togglePassword")
    .addEventListener("click", function (e) {
      e.preventDefault();
      const pwd = document.getElementById("password");
      const icon = document.getElementById("eyeIcon");
      if (pwd.type === "password") {
        pwd.type = "text";
        icon.outerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" id="eyeIcon" class="icon icon-tabler icon-tabler-eye" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="2" />
          <path d="M22 12c-2.4 4 -5.4 6 -10 6c-4.6 0 -7.6 -2 -10 -6c2.4 -4 5.4 -6 10 -6c4.6 0 7.6 2 10 6" />
        </svg>`;
      } else {
        pwd.type = "password";
        icon.outerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" id="eyeIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-eye-closed">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M21 9c-2.4 2.667 -5.4 4 -9 4c-3.6 0 -6.6 -1.333 -9 -4" />
          <path d="M3 15l2.5 -3.8" />
          <path d="M21 14.976l-2.492 -3.776" />
          <path d="M9 17l.5 -4" />
          <path d="M15 17l-.5 -4" />
        </svg>`;
      }
    });

  // ---- TOAST FUNCTION ----
  function showToast(type, message) {
    const color = type === "success" ? "bg-success" : "bg-danger";
    const toast = document.createElement("div");
    toast.className = `toast align-items-center text-white ${color} border-0 show`;
    toast.role = "alert";
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }

  // ---- VALIDATION + SUBMIT ----
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    inputs.forEach((i) => i.classList.remove("is-valid", "is-invalid"));

    let valid = true;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    inputs.forEach((input) => {
      const value = input.value.trim();
      if (input.id === "email" && !emailRegex.test(value)) {
        input.classList.add("is-invalid");
        valid = false;
        input.nextElementSibling.textContent =
          "Please enter a valid email address.";
        return;
      }
      if (!value) {
        input.classList.add("is-invalid");
        valid = false;
      } else {
        input.classList.add("is-valid");
      }
    });

    if (!valid) {
      showToast("error", "Please fix the highlighted fields.");
      return;
    }

    const username = document.getElementById("username").value.trim();

    try {
      const response = await fetch("/api/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username: document.getElementById("username").value.trim(),
          email: document.getElementById("email").value.trim(),
          password: document.getElementById("password").value,
        }),
      });

      const data = await response.json();

      if (response.ok) {
        showToast("success", "Account created successfully!");
        setTimeout(() => (window.location.href = `/${username}`), 1500);
      } else {
        showToast("error", data.detail || "Registration failed.");
      }
    } catch (err) {
      showToast("error", "Server connection error.");
    }
  });
</script>

{% endblock %}
